generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("viewer") // "admin" | "viewer"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servers Server[]

  @@map("users")
}

model Server {
  id                 String   @id @default(uuid())
  name               String
  url                String
  checkType          String   @default("http")
  intervalSec        Int      @default(60)
  degradedThresholdMs Int     @default(5000)
  status             String   @default("unknown")
  enabled            Boolean  @default(true)
  isPublic           Boolean  @default(false)
  createdById        String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  createdBy     User?          @relation(fields: [createdById], references: [id], onDelete: SetNull)
  checks        Check[]
  notifications Notification[]
  incidents     Incident[]

  @@map("servers")
}

model Check {
  id             String   @id @default(uuid())
  serverId       String
  status         String
  responseTimeMs Int?
  statusCode     Int?
  errorMessage   String?
  checkedAt      DateTime @default(now())

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId, checkedAt])
  @@map("checks")
}

model Notification {
  id          String   @id @default(uuid())
  serverId    String
  type        String   @default("whatsapp")
  destination String
  triggerOn   String   @default("down") // "down" | "degraded" | "both"
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model NotificationLog {
  id           String   @id @default(uuid())
  serverId     String
  destination  String
  message      String
  success      Boolean
  errorMessage String?
  sentAt       DateTime @default(now())

  @@index([serverId, sentAt])
  @@map("notification_logs")
}

model Incident {
  id         String    @id @default(uuid())
  serverId   String
  status     String    // "down" | "degraded"
  startedAt  DateTime  @default(now())
  resolvedAt DateTime?
  durationMs Int?

  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([serverId, startedAt])
  @@map("incidents")
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}
